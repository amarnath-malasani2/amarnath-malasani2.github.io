<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>My Addresses - Delivery Management</title>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;700;900&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <!-- MapLibre CSS -->
    <link href='https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.css' rel='stylesheet' />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style type="text/tailwindcss">
        :root {
            --golden-yellow: #FFD700;
            --dark-blue: #0C2D57;
        }

        /* Smooth transitions */
        .transition-slow {
            transition: all 0.3s ease;
        }
        
        /* Map container */
        #map-container {
            height: 400px;
            width: 100%;
            border-radius: 0.5rem;
            overflow: hidden;
            margin-top: 1rem;
        }
        
        /* MapLibre popup customization */
        .maplibregl-popup-content {
            border-radius: 0.5rem;
            padding: 1rem;
        }
        
        /* Toast notification */
        #toast {
            transition: opacity 0.3s ease;
        }
        
        /* Loading spinner */
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Delivery status badges */
        .delivery-badge {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #0C2D57;
        }
        
        /* Pulse animation for active delivery */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .pulse-delivery {
            animation: pulse 2s infinite;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#0C2D57",
                        "background-light": "#f6f7f8",
                        "content-light": "#ffffff",
                        "text-light": "#111827",
                        "subtext-light": "#64748b",
                        "danger": "#ef4444",
                        "success": "#10b981"
                    },
                    fontFamily: {
                        "display": ["Work Sans", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.5rem",
                        "lg": "0.75rem",
                        "xl": "1rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        body {
            min-height: max(884px, 100dvh);
            background-color: #f6f7f8;
        }

        /* Custom styles with your colors */
        .golden-bg {
            background-color: #FFD700;
        }

        .dark-blue-text {
            color: #0C2D57;
        }

        .dark-blue-bg {
            background-color: #0C2D57;
        }
        
        /* MapLibre marker customization */
        .delivery-marker {
            background-color: #FFD700;
            border: 3px solid #0C2D57;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .delivery-marker::after {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            border: 2px solid #FFD700;
            border-radius: 50%;
            animation: ripple 1.5s infinite;
        }
        
        @keyframes ripple {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(2.5); opacity: 0; }
        }
    </style>
</head>

<body class="font-display">
    <div class="relative flex min-h-screen w-full flex-col max-w-screen-2xl mx-auto">
        <!-- Address Modal -->
        <div id="address-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 hidden">
            <div class="bg-white rounded-xl shadow-lg w-full max-w-md mx-4 p-6 relative max-h-[90vh] overflow-y-auto">
                <button type="button" onclick="closeModal()"
                    class="absolute top-2 right-2 p-2 rounded-full hover:bg-gray-100">
                    <span class="material-symbols-outlined">close</span>
                </button>
                <h2 id="modal-title" class="text-xl font-bold mb-4">Add Delivery Address</h2>
                <form id="address-form" class="space-y-4">
                    <input type="hidden" id="edit-index" />
                    <div>
                        <label class="block text-sm font-medium mb-1" for="address-label">Label *</label>
                        <input id="address-label" class="w-full rounded-lg border p-2" type="text"
                            placeholder="e.g. Home, Work, Restaurant" required />
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1" for="address-line">Address *</label>
                        <input id="address-line" class="w-full rounded-lg border p-2" type="text"
                            placeholder="Street, Building, Apt, etc." required />
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1" for="address-city">City *</label>
                            <input id="address-city" class="w-full rounded-lg border p-2" type="text" required />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1" for="address-zip">ZIP Code *</label>
                            <input id="address-zip" class="w-full rounded-lg border p-2" type="text" required />
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1" for="address-country">Country *</label>
                        <input id="address-country" class="w-full rounded-lg border p-2" type="text" required />
                    </div>

                    <!-- Delivery Instructions -->
                    <div>
                        <label class="block text-sm font-medium mb-1" for="delivery-notes">
                            Delivery Instructions
                        </label>
                        <textarea id="delivery-notes" class="w-full rounded-lg border p-2" 
                            rows="2" placeholder="e.g., Call before delivery, Leave at security, Gate code, etc."></textarea>
                    </div>

                    <!-- Preferred Delivery Time -->
                    <div>
                        <label class="block text-sm font-medium mb-1" for="delivery-time">
                            Preferred Delivery Time
                        </label>
                        <select id="delivery-time" class="w-full rounded-lg border p-2">
                            <option value="">Any time</option>
                            <option value="morning">Morning (9 AM - 12 PM)</option>
                            <option value="afternoon">Afternoon (12 PM - 5 PM)</option>
                            <option value="evening">Evening (5 PM - 9 PM)</option>
                        </select>
                    </div>

                    <!-- Map Location Selection -->
                    <div>
                        <label class="block text-sm font-medium mb-1">Delivery Location on Map *</label>
                        <button type="button" onclick="openMapModal()"
                            class="flex items-center gap-2 text-primary mb-2">
                            <span class="material-symbols-outlined">map</span>
                            <span>Select Delivery Location</span>
                        </button>
                        <div class="text-xs text-subtext-light bg-blue-50 p-2 rounded">
                            <span class="font-medium">Selected:</span>
                            <span id="coordinates-display">No location selected (required for delivery)</span>
                        </div>
                        <input type="hidden" id="address-lat" />
                        <input type="hidden" id="address-lng" />
                    </div>

                    <div class="flex items-center gap-2">
                        <input id="address-default" type="checkbox" class="rounded" />
                        <label for="address-default" class="text-sm">Set as default delivery address</label>
                    </div>
                    <button type="submit"
                        class="w-full golden-bg dark-blue-text font-bold rounded-lg py-3 mt-2 hover:bg-[#e6c200] flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">delivery_dining</span>
                        Save Delivery Address
                    </button>
                </form>
            </div>
        </div>

        <!-- Map Modal -->
        <div id="map-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 hidden">
            <div class="bg-white rounded-xl shadow-lg w-full max-w-4xl mx-4 p-6 relative h-[90vh] flex flex-col">
                <button type="button" onclick="closeMapModal()"
                    class="absolute top-2 right-2 p-2 rounded-full hover:bg-gray-100 z-10">
                    <span class="material-symbols-outlined">close</span>
                </button>
                <h2 class="text-xl font-bold mb-4">Select Delivery Location</h2>
                <div class="flex gap-2 mb-4 flex-wrap">
                    <button id="locate-btn" onclick="locateUser()"
                        class="flex items-center gap-1 text-sm bg-primary text-white px-3 py-2 rounded-lg hover:bg-blue-700">
                        <span class="material-symbols-outlined">my_location</span>
                        Use My Location
                    </button>
                    <div id="locate-loading"
                        class="hidden items-center gap-1 text-sm bg-primary/10 text-primary px-3 py-2 rounded-lg">
                        <div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div>
                        <span>Getting location...</span>
                    </div>
                    <div class="text-sm text-subtext-light flex items-center">
                        <span class="material-symbols-outlined text-sm mr-1">info</span>
                        Click on map to set delivery location
                    </div>
                </div>
                <div id="map-container" class="flex-1"></div>
                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" onclick="closeMapModal()"
                        class="px-4 py-2 rounded-lg border hover:bg-gray-100">
                        Cancel
                    </button>
                    <button type="button" onclick="confirmLocation()" id="confirm-location-btn"
                        class="px-4 py-2 rounded-lg golden-bg dark-blue-text font-bold hover:bg-[#e6c200] disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled>
                        Confirm Delivery Location
                    </button>
                </div>
            </div>
        </div>

        <!-- Header -->
        <header class="dark-blue-bg text-white sticky top-0 z-10 shadow-md">
            <div class="px-3 sm:px-6 lg:px-12 xl:px-16">
                <div class="flex h-16 sm:h-20 lg:h-24 items-center justify-between">
                    <button class="p-2 -ml-2" onclick="window.location.href='profile.html'" aria-label="Go back">
                        <svg fill="currentColor" height="24" viewBox="0 0 256 256" width="24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z">
                            </path>
                        </svg>
                    </button>
                    <h1 class="text-lg sm:text-xl lg:text-2xl xl:text-3xl font-bold">My Delivery Addresses</h1>
                    <div class="w-10 h-10 flex-shrink-0"></div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow">
            <!-- Quick Actions -->
            <div class="px-3 sm:px-6 lg:px-12 xl:px-16 pt-6">
                <div class="bg-gradient-to-r from-primary to-blue-700 rounded-lg p-4 text-white mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-lg font-bold mb-1">Delivery Ready</h2>
                            <p class="text-blue-100 text-sm">Manage your delivery addresses and preferences</p>
                        </div>
                        <div class="flex items-center gap-2 delivery-badge px-3 py-1 rounded-full text-sm font-bold">
                            <span class="material-symbols-outlined text-sm">local_shipping</span>
                            Active
                        </div>
                    </div>
                </div>
            </div>

            <div id="addresses-list" class="px-3 sm:px-6 lg:px-12 xl:px-16 pb-8 space-y-4"></div>
            <div id="empty-state" class="hidden flex flex-col items-center justify-center py-16 px-4 text-center">
                <span class="material-symbols-outlined text-6xl text-primary/50 mb-4">location_off</span>
                <p class="text-lg text-subtext-light mb-2">No delivery addresses found</p>
                <p class="text-subtext-light mb-6 max-w-md">Add your first delivery address to start receiving orders and deliveries.</p>
                <button onclick="openModal()"
                    class="golden-bg dark-blue-text font-bold rounded-lg px-6 py-3 hover:bg-[#e6c200] flex items-center gap-2">
                    <span class="material-symbols-outlined">add_location</span>
                    Add Delivery Address
                </button>
            </div>
        </main>

        <!-- Add New Address Button -->
        <div class="p-3 sm:p-6 lg:p-12 xl:p-16 sticky bottom-0 bg-background-light border-t border-gray-200">
            <button onclick="openModal()" class="flex w-full items-center justify-center gap-2 rounded-lg 
                 h-12 sm:h-14 lg:h-16  
                 px-6 lg:px-8  
                 golden-bg dark-blue-text font-bold hover:bg-[#e6c200] active:bg-[#ccad00] 
                 transition-colors focus:outline-none focus:ring-2 focus:ring-primary/50 shadow-lg">
                <span class="material-symbols-outlined">add_location</span>
                <span class="truncate">Add New Delivery Address</span>
            </button>
        </div>

        <div class="h-5"></div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-primary text-white px-6 py-3 rounded-lg shadow-lg z-50 max-w-md text-center"></div>

    <!-- MapLibre JS -->
    <script src='https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.js'></script>
    <script>
        // Delivery Address Management System
        let addresses = JSON.parse(localStorage.getItem('delivery_addresses') || '[]');
        let defaultIndex = parseInt(localStorage.getItem('default_delivery_address') || '0');
        let map = null;
        let marker = null;
        let selectedLocation = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            renderAddresses();
        });

        function renderAddresses() {
            const list = document.getElementById('addresses-list');
            const empty = document.getElementById('empty-state');
            list.innerHTML = '';
            
            if (!addresses.length) {
                list.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }
            
            list.classList.remove('hidden');
            empty.classList.add('hidden');
            
            addresses.forEach((addr, i) => {
                const card = document.createElement('div');
                card.className = `bg-content-light rounded-lg shadow-sm overflow-hidden border-2 transition-all hover:shadow-md ${
                    i === defaultIndex ? 'border-golden-yellow border-2' : 'border-transparent'
                }`;
                
                const deliveryEstimate = addr.lat && addr.lng ? 
                    `<div class="mt-2 text-xs text-success font-medium">
                        <span class="material-symbols-outlined align-middle text-sm">check_circle</span>
                        <span>Ready for delivery</span>
                    </div>` : 
                    `<div class="mt-2 text-xs text-danger">
                        <span class="material-symbols-outlined align-middle text-sm">warning</span>
                        <span>Location needed for delivery</span>
                    </div>`;
                
                card.innerHTML = `
                    <div class="p-4 sm:p-6">
                        <div class="flex items-start justify-between">
                            <div class="space-y-2 flex-1">
                                <div class="flex items-center gap-3">
                                    <div class="flex h-12 w-12 items-center justify-center rounded-full bg-primary/10 text-primary">
                                        <span class="material-symbols-outlined text-xl">
                                            ${getDeliveryIcon(addr.label)}
                                        </span>
                                    </div>
                                    <div>
                                        <h2 class="text-lg sm:text-xl font-bold text-text-light flex items-center gap-2">
                                            ${addr.label}
                                            ${i === defaultIndex ? 
                                                '<span title="Default delivery address" class="material-symbols-outlined text-yellow-500">star</span>' : 
                                                ''}
                                        </h2>
                                        ${deliveryEstimate}
                                    </div>
                                </div>
                                <div class="pl-15">
                                    <p class="text-text-light font-medium">${addr.line}</p>
                                    <p class="text-subtext-light">${addr.city}, ${addr.zip}</p>
                                    <p class="text-subtext-light">${addr.country}</p>
                                    ${addr.deliveryNotes ? 
                                        `<p class="text-xs text-primary mt-2">
                                            <span class="font-medium">Delivery instructions:</span> ${addr.deliveryNotes}
                                        </p>` : ''}
                                    ${addr.deliveryTime ? 
                                        `<p class="text-xs text-subtext-light mt-1">
                                            <span class="font-medium">Preferred time:</span> ${getDeliveryTimeText(addr.deliveryTime)}
                                        </p>` : ''}
                                </div>
                            </div>
                            <div class="flex flex-col gap-2 items-end">
                                <button onclick="setAsDeliveryLocation(${i})" 
                                    class="flex items-center gap-1 text-sm bg-success text-white px-3 py-2 rounded-lg hover:bg-green-600 transition-colors">
                                    <span class="material-symbols-outlined text-sm">delivery_dining</span>
                                    Deliver Here
                                </button>
                                <div class="flex gap-1">
                                    <button onclick="editAddress(${i})" 
                                        class="p-2 rounded-full hover:bg-primary/5 transition-slow"
                                        title="Edit address">
                                        <span class="material-symbols-outlined text-primary">edit</span>
                                    </button>
                                    <button onclick="deleteAddress(${i})" 
                                        class="p-2 rounded-full hover:bg-danger/5 transition-slow"
                                        title="Delete address">
                                        <span class="material-symbols-outlined text-danger">delete</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function getDeliveryIcon(label) {
            const lowerLabel = label.toLowerCase();
            if (lowerLabel.includes('home') || lowerLabel.includes('house')) return 'home';
            if (lowerLabel.includes('work') || lowerLabel.includes('office')) return 'work';
            if (lowerLabel.includes('restaurant')) return 'restaurant';
            if (lowerLabel.includes('school') || lowerLabel.includes('college')) return 'school';
            if (lowerLabel.includes('store') || lowerLabel.includes('shop')) return 'store';
            return 'location_on';
        }

        function getDeliveryTimeText(time) {
            const times = {
                'morning': 'Morning (9 AM - 12 PM)',
                'afternoon': 'Afternoon (12 PM - 5 PM)',
                'evening': 'Evening (5 PM - 9 PM)'
            };
            return times[time] || 'Any time';
        }

        function openModal(editIdx) {
            document.getElementById('address-modal').classList.remove('hidden');
            document.getElementById('address-form').reset();
            document.getElementById('edit-index').value = '';
            document.getElementById('coordinates-display').textContent = 'No location selected (required for delivery)';
            document.getElementById('address-lat').value = '';
            document.getElementById('address-lng').value = '';
            selectedLocation = null;
            
            const isEdit = editIdx !== undefined;
            document.getElementById('modal-title').textContent = isEdit ? 'Edit Delivery Address' : 'Add Delivery Address';
            
            if (isEdit) {
                const addr = addresses[editIdx];
                document.getElementById('address-label').value = addr.label;
                document.getElementById('address-line').value = addr.line;
                document.getElementById('address-city').value = addr.city;
                document.getElementById('address-zip').value = addr.zip;
                document.getElementById('address-country').value = addr.country;
                document.getElementById('delivery-notes').value = addr.deliveryNotes || '';
                document.getElementById('delivery-time').value = addr.deliveryTime || '';
                document.getElementById('address-default').checked = (editIdx === defaultIndex);
                document.getElementById('edit-index').value = editIdx;

                if (addr.lat && addr.lng) {
                    document.getElementById('address-lat').value = addr.lat;
                    document.getElementById('address-lng').value = addr.lng;
                    document.getElementById('coordinates-display').textContent =
                        `${parseFloat(addr.lat).toFixed(6)}, ${parseFloat(addr.lng).toFixed(6)}`;
                    selectedLocation = { lat: parseFloat(addr.lat), lng: parseFloat(addr.lng) };
                }
            }
        }

        function closeModal() {
            document.getElementById('address-modal').classList.add('hidden');
        }

        function openMapModal() {
            document.getElementById('map-modal').classList.remove('hidden');
            setTimeout(initMap, 100); // Small delay to ensure DOM is ready
        }

        function closeMapModal() {
            document.getElementById('map-modal').classList.add('hidden');
            if (map) {
                map.remove();
                map = null;
                marker = null;
            }
        }

        function initMap() {
            // Initialize MapLibre map
            map = new maplibregl.Map({
                container: 'map-container',
                style: {
                    version: 8,
                    sources: {
                        'osm-tiles': {
                            type: 'raster',
                            tiles: ['https://a.tile.openstreetmap.org/{z}/{x}/{y}.png', 'https://b.tile.openstreetmap.org/{z}/{x}/{y}.png', 'https://c.tile.openstreetmap.org/{z}/{x}/{y}.png'],
                            tileSize: 256,
                            attribution: 'Â© OpenStreetMap Contributors'
                        }
                    },
                    layers: [{
                        id: 'osm-tiles',
                        type: 'raster',
                        source: 'osm-tiles',
                        minzoom: 0,
                        maxzoom: 19
                    }]
                },
                center: [78.9629, 20.5937], // India center
                zoom: 4
            });

            // Add navigation controls
            map.addControl(new maplibregl.NavigationControl());

            // Add geolocation control
            map.addControl(new maplibregl.GeolocateControl({
                positionOptions: {
                    enableHighAccuracy: true
                },
                trackUserLocation: true,
                showUserLocation: true,
                showAccuracyCircle: true
            }));

            // Add click event to set marker
            map.on('click', function(e) {
                setMarker(e.lngLat);
                reverseGeocode(e.lngLat.lat, e.lngLat.lng);
            });

            // If we have a previously selected location, center there
            if (selectedLocation) {
                map.setCenter([selectedLocation.lng, selectedLocation.lat]);
                map.setZoom(15);
                setMarker({ lng: selectedLocation.lng, lat: selectedLocation.lat });
            }

            // Enable confirm button if location is already selected
            updateConfirmButton();
        }

        function setMarker(lngLat) {
            // Remove existing marker
            if (marker) {
                marker.remove();
            }

            // Create custom marker element
            const el = document.createElement('div');
            el.className = 'delivery-marker';
            el.innerHTML = '<div class="delivery-marker-inner"></div>';

            // Add marker to map
            marker = new maplibregl.Marker({
                element: el,
                draggable: true
            })
                .setLngLat(lngLat)
                .addTo(map);

            // Add drag end event
            marker.on('dragend', function() {
                const newLngLat = marker.getLngLat();
                selectedLocation = { lat: newLngLat.lat, lng: newLngLat.lng };
                reverseGeocode(newLngLat.lat, newLngLat.lng);
            });

            selectedLocation = { lat: lngLat.lat, lng: lngLat.lng };
            updateConfirmButton();
        }

        function locateUser() {
            if (!navigator.geolocation) {
                showToast('Geolocation is not supported by your browser');
                return;
            }

            // Show loading state
            document.getElementById('locate-btn').classList.add('hidden');
            document.getElementById('locate-loading').classList.remove('hidden');

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    map.setCenter([userLocation.lng, userLocation.lat]);
                    map.setZoom(15);
                    setMarker({ lng: userLocation.lng, lat: userLocation.lat });
                    reverseGeocode(userLocation.lat, userLocation.lng);

                    // Hide loading state
                    document.getElementById('locate-btn').classList.remove('hidden');
                    document.getElementById('locate-loading').classList.add('hidden');
                },
                function(error) {
                    // Hide loading state
                    document.getElementById('locate-btn').classList.remove('hidden');
                    document.getElementById('locate-loading').classList.add('hidden');

                    let errorMsg = 'Unable to retrieve your location';
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'Location access denied. Please enable location services for accurate delivery.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'Location information is unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMsg = 'Location request timed out. Please try again.';
                            break;
                    }
                    showToast(errorMsg);
                },
                { 
                    enableHighAccuracy: true, 
                    timeout: 15000, 
                    maximumAge: 60000 
                }
            );
        }

        async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`
                );
                const data = await response.json();
                
                if (data && data.address) {
                    populateDeliveryForm(data.address);
                }
            } catch (error) {
                console.error('Reverse geocoding error:', error);
                showToast('Unable to fetch address details. Please enter manually.');
            }
        }

        function populateDeliveryForm(address) {
            const addr = address;
            
            // Smart address parsing for delivery
            let addressLine = '';
            if (addr.house_number) addressLine += addr.house_number + ' ';
            if (addr.road) addressLine += addr.road;
            if (!addressLine && addr.pedestrian) addressLine = addr.pedestrian;
            if (!addressLine && addr.footway) addressLine = addr.footway;

            document.getElementById('address-line').value = addressLine || '';
            document.getElementById('address-city').value = 
                addr.city || addr.town || addr.village || addr.county || '';
            document.getElementById('address-zip').value = addr.postcode || '';
            document.getElementById('address-country').value = addr.country || '';

            // Auto-suggest delivery-friendly labels
            if (!document.getElementById('address-label').value) {
                const label = suggestDeliveryLabel(addr);
                document.getElementById('address-label').value = label;
            }

            // Suggest delivery notes
            suggestDeliveryNotes(addr);
        }

        function suggestDeliveryLabel(address) {
            if (address.amenity === 'restaurant') return 'Restaurant Pickup';
            if (address.amenity === 'school' || address.amenity === 'university') return 'School/College';
            if (address.office) return 'Office Delivery';
            if (address.retail || address.shop) return 'Store Delivery';
            if (address.house_number) return 'Home Delivery';
            return 'Delivery Location';
        }

        function suggestDeliveryNotes(address) {
            const notes = [];
            if (address.entrance) notes.push(`Entrance: ${address.entrance}`);
            if (address.building) notes.push(`Building: ${address.building}`);
            if (address.floor) notes.push(`Floor: ${address.floor}`);
            
            const notesField = document.getElementById('delivery-notes');
            if (notes.length > 0 && !notesField.value) {
                notesField.value = notes.join(', ');
            }
        }

        function updateConfirmButton() {
            const btn = document.getElementById('confirm-location-btn');
            if (selectedLocation) {
                btn.disabled = false;
            } else {
                btn.disabled = true;
            }
        }

        function confirmLocation() {
            if (selectedLocation) {
                document.getElementById('address-lat').value = selectedLocation.lat;
                document.getElementById('address-lng').value = selectedLocation.lng;
                document.getElementById('coordinates-display').textContent =
                    `${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}`;
                showToast('Delivery location confirmed!');
            }
            closeMapModal();
        }

        // Form submission
        document.getElementById('address-form').onsubmit = async function(e) {
            e.preventDefault();
            
            // Validate form
            const label = document.getElementById('address-label').value.trim();
            const line = document.getElementById('address-line').value.trim();
            const city = document.getElementById('address-city').value.trim();
            const zip = document.getElementById('address-zip').value.trim();
            const country = document.getElementById('address-country').value.trim();
            const lat = document.getElementById('address-lat').value;
            const lng = document.getElementById('address-lng').value;
            
            // Delivery-specific validation
            const errors = validateDeliveryAddress({ label, line, city, zip, country, lat, lng });
            if (errors.length > 0) {
                showToast(errors[0]);
                return;
            }
            
            const deliveryNotes = document.getElementById('delivery-notes').value.trim();
            const deliveryTime = document.getElementById('delivery-time').value;
            const isDefault = document.getElementById('address-default').checked;
            const idx = document.getElementById('edit-index').value;

            const addressData = { 
                label, 
                line, 
                city, 
                zip, 
                country,
                deliveryNotes: deliveryNotes || undefined,
                deliveryTime: deliveryTime || undefined
            };
            
            if (lat && lng) {
                addressData.lat = lat;
                addressData.lng = lng;
            }

            // Show loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; border-width: 2px; margin: 0 auto;"></div>';

            try {
                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                if (idx !== '') {
                    // Edit existing address
                    addresses[idx] = addressData;
                    if (isDefault) defaultIndex = parseInt(idx);
                } else {
                    // Add new address
                    addresses.push(addressData);
                    if (isDefault) defaultIndex = addresses.length - 1;
                }
                
                localStorage.setItem('delivery_addresses', JSON.stringify(addresses));
                localStorage.setItem('default_delivery_address', defaultIndex);
                
                closeModal();
                renderAddresses();
                showToast('Delivery address saved successfully! ðŸŽ‰');
            } catch (error) {
                showToast('Failed to save address. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        };

        function validateDeliveryAddress(address) {
            const errors = [];
            
            if (!address.label) errors.push('Please enter a label for this delivery address');
            if (!address.line) errors.push('Street address is required for delivery');
            if (!address.city) errors.push('City is required for delivery routing');
            if (!address.zip) errors.push('ZIP code is required for delivery');
            if (!address.country) errors.push('Country is required for delivery');
            if (!address.lat || !address.lng) errors.push('Map location is required for accurate delivery');
            
            return errors;
        }

        function editAddress(i) {
            openModal(i);
        }

        function deleteAddress(i) {
            const addressLabel = addresses[i].label;
            if (confirm(`Are you sure you want to delete the delivery address "${addressLabel}"?\n\nThis will remove it from all future deliveries.`)) {
                addresses.splice(i, 1);
                if (defaultIndex === i) defaultIndex = Math.max(0, addresses.length - 1);
                if (defaultIndex > i) defaultIndex--;
                localStorage.setItem('delivery_addresses', JSON.stringify(addresses));
                localStorage.setItem('default_delivery_address', defaultIndex);
                renderAddresses();
                showToast('Delivery address deleted');
            }
        }

        function setAsDeliveryLocation(i) {
            defaultIndex = i;
            localStorage.setItem('default_delivery_address', defaultIndex);
            renderAddresses();
            showToast('Default delivery address updated! âœ…');
        }

        // Toast notification
        function showToast(msg) {
            let toast = document.getElementById('toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast';
                toast.className = 'fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-primary text-white px-6 py-3 rounded-lg shadow-lg z-50 hidden';
                document.body.appendChild(toast);
            }
            toast.textContent = msg;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 4000);
        }
    </script>
</body>
</html>
